#pragma once

#include <algorithm>

#include "board.h"
#include "move.h"
#include "ls1b.h"

using std::min;

struct stack_drop_hash_entry {
	unsigned int stack_drop;
	int length;
}

#if BOARD_SIZE == 3
constexpr array<array<stack_drop_hash_entry, 4>, 3> STACK_DROP_HASH = {{
	{{ // 1
		{17u, 1},
	}},
	{{ // 2
		{529u, 2},
		{34u, 1}
	}},
	{{ // 3
		{12561u, 3},
		{786u, 2},
		{801u, 2},
		{51u, 1}
	}}
}};
constexpr array<array<int, 4>, 9> MAX_STACK_MOVE_LENGTH = {
	{0, 2, 2, 0},
	{0, 1, 2, 1},
	{0, 0, 2, 2},
	{1, 2, 1, 0},
	{1, 1, 1, 1},
	{1, 0, 1, 2},
	{2, 2, 0, 0},
	{2, 1, 0, 1},
	{2, 0, 0, 2}
};

#elif BOARD_SIZE == 4
constexpr array<array<stack_drop_hash_entry, 8>, 4> STACK_DROP_HASH = {{
	{{ // 1
		{17u, 1}
	}},
	{{ // 2
		{529u, 2},
		{34u, 1}
	}},
	{{ // 3
		{12561u, 3},
		{786u, 2},
		{801u, 2},
		{51u, 1}
	}},
	{{ // 4
		{266513u, 4},
		{16658u, 3},
		{16673u, 3},
		{1043u, 2},
		{16913u, 3},
		{1058u, 2},
		{1073u, 2},
		{68u, 1}
	}}
}};
constexpr array<array<int, 4>, 16> MAX_STACK_MOVE_LENGTH = {
	{0, 3, 3, 0},
	{0, 2, 3, 1},
	{0, 1, 3, 2},
	{0, 0, 3, 3},
	{1, 3, 2, 0},
	{1, 2, 2, 1},
	{1, 1, 2, 2},
	{1, 0, 2, 3},
	{2, 3, 1, 0},
	{2, 2, 1, 1},
	{2, 1, 1, 2},
	{2, 0, 1, 3},
	{3, 3, 0, 0},
	{3, 2, 0, 1},
	{3, 1, 0, 2},
	{3, 0, 0, 3}
};

#elif BOARD_SIZE == 5
constexpr array<array<stack_drop_hash_entry, 16>, 5> STACK_DROP_HASH = {{
	{{ // 1
		{17u, 1}
	}},
	{{ // 2
		{529u, 2},
		{34u, 1}
	}},
	{{ // 3
		{12561u, 3},
		{786u, 2},
		{801u, 2},
		{51u, 1}
	}},
	{{ // 4
		{266513u, 4},
		{16658u, 3},
		{16673u, 3},
		{1043u, 2},
		{16913u, 3},
		{1058u, 2},
		{1073u, 2},
		{68u, 1}
	}},
	{{ // 5
		{5312785u, 5},
		{332050u, 4},
		{332065u, 4},
		{20755u, 3},
		{332305u, 4},
		{20770u, 3},
		{20785u, 3},
		{1300u, 2},
		{336145u, 4},
		{21010u, 3},
		{21025u, 3},
		{1315u, 2},
		{21265u, 3},
		{1330u, 2},
		{1345u, 2},
		{85u, 1}
	}}
}};
constexpr array<array<int, 4>, 25> MAX_STACK_MOVE_LENGTH = {
	{0, 4, 4, 0},
	{0, 3, 4, 1},
	{0, 2, 4, 2},
	{0, 1, 4, 3},
	{0, 0, 4, 4},
	{1, 4, 3, 0},
	{1, 3, 3, 1},
	{1, 2, 3, 2},
	{1, 1, 3, 3},
	{1, 0, 3, 4},
	{2, 4, 2, 0},
	{2, 3, 2, 1},
	{2, 2, 2, 2},
	{2, 1, 2, 3},
	{2, 0, 2, 4},
	{3, 4, 1, 0},
	{3, 3, 1, 1},
	{3, 2, 1, 2},
	{3, 1, 1, 3},
	{3, 0, 1, 4},
	{4, 4, 0, 0},
	{4, 3, 0, 1},
	{4, 2, 0, 2},
	{4, 1, 0, 3},
	{4, 0, 0, 4}
};

#elif BOARD_SIZE == 6
constexpr array<array<stack_drop_hash_entry, 32>, 6> STACK_DROP_HASH = {{
	{{ // 1
		{17u, 1}
	}},
	{{ // 2
		{529u, 2},
		{34u, 1}
	}},
	{{ // 3
		{12561u, 3},
		{786u, 2},
		{801u, 2},
		{51u, 1}
	}},
	{{ // 4
		{266513u, 4},
		{16658u, 3},
		{16673u, 3},
		{1043u, 2},
		{16913u, 3},
		{1058u, 2},
		{1073u, 2},
		{68u, 1}
	}},
	{{ // 5
		{5312785u, 5},
		{332050u, 4},
		{332065u, 4},
		{20755u, 3},
		{332305u, 4},
		{20770u, 3},
		{20785u, 3},
		{1300u, 2},
		{336145u, 4},
		{21010u, 3},
		{21025u, 3},
		{1315u, 2},
		{21265u, 3},
		{1330u, 2},
		{1345u, 2},
		{85u, 1}
	}},
	{{ // 6
		{101781777u, 6},
		{6361362u, 5},
		{6361377u, 5},
		{397587u, 4},
		{6361617u, 5},
		{397602u, 4},
		{397617u, 4},
		{24852u, 3},
		{6365457u, 5},
		{397842u, 4},
		{397857u, 4},
		{24867u, 3},
		{398097u, 4},
		{24882u, 3},
		{24897u, 3},
		{1557u, 2},
		{6426897u, 5},
		{401682u, 4},
		{401697u, 4},
		{25107u, 3},
		{401937u, 4},
		{25122u, 3},
		{25137u, 3},
		{1572u, 2},
		{405777u, 4},
		{25362u, 3},
		{25377u, 3},
		{1587u, 2},
		{25617u, 3},
		{1602u, 2},
		{1617u, 2},
		{102u, 1}
	}}
}};
constexpr array<array<int, 4>, 36> MAX_STACK_MOVE_LENGTH = {
	{0, 5, 5, 0},
	{0, 4, 5, 1},
	{0, 3, 5, 2},
	{0, 2, 5, 3},
	{0, 1, 5, 4},
	{0, 0, 5, 5},
	{1, 5, 4, 0},
	{1, 4, 4, 1},
	{1, 3, 4, 2},
	{1, 2, 4, 3},
	{1, 1, 4, 4},
	{1, 0, 4, 5},
	{2, 5, 3, 0},
	{2, 4, 3, 1},
	{2, 3, 3, 2},
	{2, 2, 3, 3},
	{2, 1, 3, 4},
	{2, 0, 3, 5},
	{3, 5, 2, 0},
	{3, 4, 2, 1},
	{3, 3, 2, 2},
	{3, 2, 2, 3},
	{3, 1, 2, 4},
	{3, 0, 2, 5},
	{4, 5, 1, 0},
	{4, 4, 1, 1},
	{4, 3, 1, 2},
	{4, 2, 1, 3},
	{4, 1, 1, 4},
	{4, 0, 1, 5},
	{5, 5, 0, 0},
	{5, 4, 0, 1},
	{5, 3, 0, 2},
	{5, 2, 0, 3},
	{5, 1, 0, 4},
	{5, 0, 0, 5}
};

#elif BOARD_SIZE == 7
constexpr array<array<stack_drop_hash_entry, 64>, 7> STACK_DROP_HASH = {{
	{{ // 1
		{17u, 1}
	}},
	{{ // 2
		{529u, 2},
		{34u, 1}
	}},
	{{ // 3
		{12561u, 3},
		{786u, 2},
		{801u, 2},
		{51u, 1}
	}},
	{{ // 4
		{266513u, 4},
		{16658u, 3},
		{16673u, 3},
		{1043u, 2},
		{16913u, 3},
		{1058u, 2},
		{1073u, 2},
		{68u, 1}
	}},
	{{ // 5
		{5312785u, 5},
		{332050u, 4},
		{332065u, 4},
		{20755u, 3},
		{332305u, 4},
		{20770u, 3},
		{20785u, 3},
		{1300u, 2},
		{336145u, 4},
		{21010u, 3},
		{21025u, 3},
		{1315u, 2},
		{21265u, 3},
		{1330u, 2},
		{1345u, 2},
		{85u, 1}
	}},
	{{ // 6
		{101781777u, 6},
		{6361362u, 5},
		{6361377u, 5},
		{397587u, 4},
		{6361617u, 5},
		{397602u, 4},
		{397617u, 4},
		{24852u, 3},
		{6365457u, 5},
		{397842u, 4},
		{397857u, 4},
		{24867u, 3},
		{398097u, 4},
		{24882u, 3},
		{24897u, 3},
		{1557u, 2},
		{6426897u, 5},
		{401682u, 4},
		{401697u, 4},
		{25107u, 3},
		{401937u, 4},
		{25122u, 3},
		{25137u, 3},
		{1572u, 2},
		{405777u, 4},
		{25362u, 3},
		{25377u, 3},
		{1587u, 2},
		{25617u, 3},
		{1602u, 2},
		{1617u, 2},
		{102u, 1}
	}},
	{{ // 7
		{1896943889u, 7},
		{118558994u, 6},
		{118559009u, 6},
		{7409939u, 5},
		{118559249u, 6},
		{7409954u, 5},
		{7409969u, 5},
		{463124u, 4},
		{118563089u, 6},
		{7410194u, 5},
		{7410209u, 5},
		{463139u, 4},
		{7410449u, 5},
		{463154u, 4},
		{463169u, 4},
		{28949u, 3},
		{118624529u, 6},
		{7414034u, 5},
		{7414049u, 5},
		{463379u, 4},
		{7414289u, 5},
		{463394u, 4},
		{463409u, 4},
		{28964u, 3},
		{7418129u, 5},
		{463634u, 4},
		{463649u, 4},
		{28979u, 3},
		{463889u, 4},
		{28994u, 3},
		{29009u, 3},
		{1814u, 2},
		{119607569u, 6},
		{7475474u, 5},
		{7475489u, 5},
		{467219u, 4},
		{7475729u, 5},
		{467234u, 4},
		{467249u, 4},
		{29204u, 3},
		{7479569u, 5},
		{467474u, 4},
		{467489u, 4},
		{29219u, 3},
		{467729u, 4},
		{29234u, 3},
		{29249u, 3},
		{1829u, 2},
		{7541009u, 5},
		{471314u, 4},
		{471329u, 4},
		{29459u, 3},
		{471569u, 4},
		{29474u, 3},
		{29489u, 3},
		{1844u, 2},
		{475409u, 4},
		{29714u, 3},
		{29729u, 3},
		{1859u, 2},
		{29969u, 3},
		{1874u, 2},
		{1889u, 2},
		{119u, 1}
	}}
}};
constexpr array<array<int, 4>, 49> MAX_STACK_MOVE_LENGTH = {
	{0, 6, 6, 0},
	{0, 5, 6, 1},
	{0, 4, 6, 2},
	{0, 3, 6, 3},
	{0, 2, 6, 4},
	{0, 1, 6, 5},
	{0, 0, 6, 6},
	{1, 6, 5, 0},
	{1, 5, 5, 1},
	{1, 4, 5, 2},
	{1, 3, 5, 3},
	{1, 2, 5, 4},
	{1, 1, 5, 5},
	{1, 0, 5, 6},
	{2, 6, 4, 0},
	{2, 5, 4, 1},
	{2, 4, 4, 2},
	{2, 3, 4, 3},
	{2, 2, 4, 4},
	{2, 1, 4, 5},
	{2, 0, 4, 6},
	{3, 6, 3, 0},
	{3, 5, 3, 1},
	{3, 4, 3, 2},
	{3, 3, 3, 3},
	{3, 2, 3, 4},
	{3, 1, 3, 5},
	{3, 0, 3, 6},
	{4, 6, 2, 0},
	{4, 5, 2, 1},
	{4, 4, 2, 2},
	{4, 3, 2, 3},
	{4, 2, 2, 4},
	{4, 1, 2, 5},
	{4, 0, 2, 6},
	{5, 6, 1, 0},
	{5, 5, 1, 1},
	{5, 4, 1, 2},
	{5, 3, 1, 3},
	{5, 2, 1, 4},
	{5, 1, 1, 5},
	{5, 0, 1, 6},
	{6, 6, 0, 0},
	{6, 5, 0, 1},
	{6, 4, 0, 2},
	{6, 3, 0, 3},
	{6, 2, 0, 4},
	{6, 1, 0, 5},
	{6, 0, 0, 6}
};

#else
constexpr array<array<stack_drop_hash_entry, 128>, 8> STACK_DROP_HASH = {{
	{{ // 1
		{17u, 1}
	}},
	{{ // 2
		{529u, 2},
		{34u, 1}
	}},
	{{ // 3
		{12561u, 3},
		{786u, 2},
		{801u, 2},
		{51u, 1}
	}},
	{{ // 4
		{266513u, 4},
		{16658u, 3},
		{16673u, 3},
		{1043u, 2},
		{16913u, 3},
		{1058u, 2},
		{1073u, 2},
		{68u, 1}
	}},
	{{ // 5
		{5312785u, 5},
		{332050u, 4},
		{332065u, 4},
		{20755u, 3},
		{332305u, 4},
		{20770u, 3},
		{20785u, 3},
		{1300u, 2},
		{336145u, 4},
		{21010u, 3},
		{21025u, 3},
		{1315u, 2},
		{21265u, 3},
		{1330u, 2},
		{1345u, 2},
		{85u, 1}
	}},
	{{ // 6
		{101781777u, 6},
		{6361362u, 5},
		{6361377u, 5},
		{397587u, 4},
		{6361617u, 5},
		{397602u, 4},
		{397617u, 4},
		{24852u, 3},
		{6365457u, 5},
		{397842u, 4},
		{397857u, 4},
		{24867u, 3},
		{398097u, 4},
		{24882u, 3},
		{24897u, 3},
		{1557u, 2},
		{6426897u, 5},
		{401682u, 4},
		{401697u, 4},
		{25107u, 3},
		{401937u, 4},
		{25122u, 3},
		{25137u, 3},
		{1572u, 2},
		{405777u, 4},
		{25362u, 3},
		{25377u, 3},
		{1587u, 2},
		{25617u, 3},
		{1602u, 2},
		{1617u, 2},
		{102u, 1}
	}},
	{{ // 7
		{1896943889u, 7},
		{118558994u, 6},
		{118559009u, 6},
		{7409939u, 5},
		{118559249u, 6},
		{7409954u, 5},
		{7409969u, 5},
		{463124u, 4},
		{118563089u, 6},
		{7410194u, 5},
		{7410209u, 5},
		{463139u, 4},
		{7410449u, 5},
		{463154u, 4},
		{463169u, 4},
		{28949u, 3},
		{118624529u, 6},
		{7414034u, 5},
		{7414049u, 5},
		{463379u, 4},
		{7414289u, 5},
		{463394u, 4},
		{463409u, 4},
		{28964u, 3},
		{7418129u, 5},
		{463634u, 4},
		{463649u, 4},
		{28979u, 3},
		{463889u, 4},
		{28994u, 3},
		{29009u, 3},
		{1814u, 2},
		{119607569u, 6},
		{7475474u, 5},
		{7475489u, 5},
		{467219u, 4},
		{7475729u, 5},
		{467234u, 4},
		{467249u, 4},
		{29204u, 3},
		{7479569u, 5},
		{467474u, 4},
		{467489u, 4},
		{29219u, 3},
		{467729u, 4},
		{29234u, 3},
		{29249u, 3},
		{1829u, 2},
		{7541009u, 5},
		{471314u, 4},
		{471329u, 4},
		{29459u, 3},
		{471569u, 4},
		{29474u, 3},
		{29489u, 3},
		{1844u, 2},
		{475409u, 4},
		{29714u, 3},
		{29729u, 3},
		{1859u, 2},
		{29969u, 3},
		{1874u, 2},
		{1889u, 2},
		{119u, 1}
	}},
	{{ // 8
		{2165379346u, 7},
		{2165379361u, 7},
		{135336211u, 6},
		{2165379601u, 7},
		{135336226u, 6},
		{135336241u, 6},
		{8458516u, 5},
		{2165379601u, 7},
		{135336466u, 6},
		{135336481u, 6},
		{8458531u, 5},
		{135336721u, 6},
		{8458546u, 5},
		{8458561u, 5},
		{528661u, 4},
		{2165444881u, 7},
		{135340306u, 6},
		{135340321u, 6},
		{8458771u, 5},
		{135340561u, 6},
		{8458786u, 5},
		{8458801u, 5},
		{528676u, 4},
		{135344401u, 6},
		{8459026u, 5},
		{8459041u, 5},
		{528691u, 4},
		{8459281u, 5},
		{528706u, 4},
		{528721u, 4},
		{33046u, 3},
		{2166427921u, 7},
		{135401746u, 6},
		{135401761u, 6},
		{8462611u, 5},
		{135402001u, 6},
		{8462626u, 5},
		{8462641u, 5},
		{528916u, 4},
		{135405841u, 6},
		{8462866u, 5},
		{8462881u, 5},
		{528931u, 4},
		{8463121u, 5},
		{528946u, 4},
		{528961u, 4},
		{33061u, 3},
		{135467281u, 6},
		{8466706u, 5},
		{8466721u, 5},
		{529171u, 4},
		{8466961u, 5},
		{529186u, 4},
		{529201u, 4},
		{33076u, 3},
		{8470801u, 5},
		{529426u, 4},
		{529441u, 4},
		{33091u, 3},
		{529681u, 4},
		{33106u, 3},
		{33121u, 3},
		{2071u, 2},
		{2182156561u, 7},
		{136384786u, 6},
		{136384801u, 6},
		{8524051u, 5},
		{136385041u, 6},
		{8524066u, 5},
		{8524081u, 5},
		{532756u, 4},
		{136388881u, 6},
		{8524306u, 5},
		{8524321u, 5},
		{532771u, 4},
		{8524561u, 5},
		{532786u, 4},
		{532801u, 4},
		{33301u, 3},
		{136450321u, 6},
		{8528146u, 5},
		{8528161u, 5},
		{533011u, 4},
		{8528401u, 5},
		{533026u, 4},
		{533041u, 4},
		{33316u, 3},
		{8532241u, 5},
		{533266u, 4},
		{533281u, 4},
		{33331u, 3},
		{533521u, 4},
		{33346u, 3},
		{33361u, 3},
		{2086u, 2},
		{137433361u, 6},
		{8589586u, 5},
		{8589601u, 5},
		{536851u, 4},
		{8589841u, 5},
		{536866u, 4},
		{536881u, 4},
		{33556u, 3},
		{8593681u, 5},
		{537106u, 4},
		{537121u, 4},
		{33571u, 3},
		{537361u, 4},
		{33586u, 3},
		{33601u, 3},
		{2101u, 2},
		{8655121u, 5},
		{540946u, 4},
		{540961u, 4},
		{33811u, 3},
		{541201u, 4},
		{33826u, 3},
		{33841u, 3},
		{2116u, 2},
		{545041u, 4},
		{34066u, 3},
		{34081u, 3},
		{2131u, 2},
		{34321u, 3},
		{2146u, 2},
		{2161u, 2},
		{136u, 1}
	}}
}};
constexpr array<array<int, 4>, 64> MAX_STACK_MOVE_LENGTH = {
	{0, 7, 7, 0},
	{0, 6, 7, 1},
	{0, 5, 7, 2},
	{0, 4, 7, 3},
	{0, 3, 7, 4},
	{0, 2, 7, 5},
	{0, 1, 7, 6},
	{0, 0, 7, 7},
	{1, 7, 6, 0},
	{1, 6, 6, 1},
	{1, 5, 6, 2},
	{1, 4, 6, 3},
	{1, 3, 6, 4},
	{1, 2, 6, 5},
	{1, 1, 6, 6},
	{1, 0, 6, 7},
	{2, 7, 5, 0},
	{2, 6, 5, 1},
	{2, 5, 5, 2},
	{2, 4, 5, 3},
	{2, 3, 5, 4},
	{2, 2, 5, 5},
	{2, 1, 5, 6},
	{2, 0, 5, 7},
	{3, 7, 4, 0},
	{3, 6, 4, 1},
	{3, 5, 4, 2},
	{3, 4, 4, 3},
	{3, 3, 4, 4},
	{3, 2, 4, 5},
	{3, 1, 4, 6},
	{3, 0, 4, 7},
	{4, 7, 3, 0},
	{4, 6, 3, 1},
	{4, 5, 3, 2},
	{4, 4, 3, 3},
	{4, 3, 3, 4},
	{4, 2, 3, 5},
	{4, 1, 3, 6},
	{4, 0, 3, 7},
	{5, 7, 2, 0},
	{5, 6, 2, 1},
	{5, 5, 2, 2},
	{5, 4, 2, 3},
	{5, 3, 2, 4},
	{5, 2, 2, 5},
	{5, 1, 2, 6},
	{5, 0, 2, 7},
	{6, 7, 1, 0},
	{6, 6, 1, 1},
	{6, 5, 1, 2},
	{6, 4, 1, 3},
	{6, 3, 1, 4},
	{6, 2, 1, 5},
	{6, 1, 1, 6},
	{6, 0, 1, 7},
	{7, 7, 0, 0},
	{7, 6, 0, 1},
	{7, 5, 0, 2},
	{7, 4, 0, 3},
	{7, 3, 0, 4},
	{7, 2, 0, 5},
	{7, 1, 0, 6},
	{7, 0, 0, 7}
};

#endif

<bool white>
void gen_place_moves(const Tak_Board& board, place_move* place_moves) {
	constexpr bool piece_reserved;
	constexpr bool capstone_reserved;
	if constexpr (white) {
		piece_reserved = board.white_piece_reserved;
		capstone_reserved = board.white_capstone_reserved;
	} else {
		piece_reserved = board.black_piece_reserved;
		capstone_reserved = board.black_capstone_reserved;
	}

	bitboard empty_squares = board.empty;
	// iterate through empty squares
	while (empty_squares) {
		int sq = ls1b(empty_squares);
		empty_squares ^= (1u << sq);

		if constexpr (piece_reserved) {
			*place_moves++ = {sq, 0}; // piece
			*place_moves++ = {sq, 1}; // wall
		}
		if constexpr (capstone_reserved) {
			*place_moves++ = {sq, 0}; // capstone
		}
	}
}

<bool white>
void gen_stack_moves(const Tak_Board& board, stack_move* stack_moves) {
	// active_player_pieces = bitboard of pieces for whoevers turn it is
	bitboard active_player_pieces;
	if constexpr (white) {
		bot_squares = board.white;
	} else {
		bot_squares = board.black;
	}

	while (bot_squares) {
		int sq = ls1b(bot_squares);
		bot_squares ^= (1u << sq);

		int max_stack_height = min(BOARD_SIZE, board.board[sq].height);
		// for every direction
		for (int dir = 0; dir < 4; ++dir) {
			int max_length = MAX_STACK_MOVE_LENGTH[sq][dir];
			// for every stack height
			for (stack_height = 1; stack_height < max_stack_height; ++stack_height) {
				// for all possible stack drop combinations in stack height
				for (const auto& [stack_drop, length] : STACK_DROP_HASH[stack_height]) {
					if (length >= max_length) {
						// it is ok if max_len == length
						*stack_moves++ = {sq, dir, length, stack_drop};
					}
				}
			}
		}
	}
}